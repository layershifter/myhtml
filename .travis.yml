language: c
services:
  - docker
sudo: false

compiler:
  - clang
  - gcc

env:
  matrix:
    - TARGET=test
    - OS=el DIST=6
    - OS=el DIST=7
    - OS=fedora DIST=24
    - OS=fedora DIST=25
    - OS=ubuntu DIST=precise
    - OS=ubuntu DIST=trusty
    - OS=ubuntu DIST=xenial
    - OS=ubuntu DIST=yakkety
    - OS=debian DIST=wheezy
    - OS=debian DIST=jessie
    - OS=debian DIST=stretch

matrix:
  exclude:
    - compiler: gcc
      env: -n "$TRAVIS_TAG"
    - compiler: clang
      env: -n "${OS}"

install: false

script:
  - if [ "$TARGET" == "test" ]; then make -j2 && make clean; fi
  - if [ -n "$TRAVIS_TAG" ] && [ -n "$OS" ]; then git clone https://github.com/packpack/packpack.git packpack; fi
  - if [ -n "$TRAVIS_TAG" ] && [ -n "$OS" ]; then VERSION=${TRAVIS_TAG:1} packpack/packpack; fi

deploy:
  provider     : packagecloud
  username     : ${PACKAGECLOUD_USER}
  repository   : ${PACKAGECLOUD_REPO}
  token        : ${PACKAGECLOUD_TOKEN}
  dist         : ${OS}/${DIST}
  package_glob : build/*.{deb,rpm}
  skip_cleanup   : true
  on             :
    tags: true
    condition    : -n "${OS}"
